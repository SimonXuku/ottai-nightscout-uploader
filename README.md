# Nightscout Ottai CGM Uploader
Скрипт написан на Python для периодической отправки данных о  глюкозе от фолловера ottai в Nightscout.

* Протестировано на Российских датчиках ottai в белой коробке

Конфигурация
Скрипт использует следующие переменные окружения

| Переменная               | Описание                                                                                                                | пример                                  | Необходим |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------|------------------------------------------|----------|
| OTTAI_TOKEN                | Ottai API JWT токен Token                                                                                                 | eyJhbGciOiJIUzUxMiJ9.eyJleHAiOjE3NDQyODUzMzcsInVzZXJJZCI6IjIwMTEyMzQ1In0.qGMRGHFi7EKhDvsYQ2wfc1mL_efuFDqjcG1_wE_e5NQbuK1zx7CCvtEQHlIUKrq54pPL0AQ-rn_bB0t5Yzx1xg     | X        |
| NS_URL                | URL адрес Nightscout                                                                                                   | https://j12345678.nightscout-jino.ru/api/v1                                       |     X     |
| NS_API_SECRET       | API Secret NightScout      | H4uSur24Bkwu                                       |      X    |
| HOURS_AGO    | Перезапуск перевыгрузки данных при потере связи в часах                                                               | 5                                        |    X      |


## Получение Ottai API JWT токен 
Выберите поделиться на телефоне мастера и введите адрес почты фолловера

**Нельзя быть самому себе мастером и фолловером. Адреса почт должны отличаться!**

Запустите приложение Ottai Share на мобильном телефоне и зарегистрируйтесь в нем в качествек фолловера.

Установите приложение для захвата пакетов на свой мобильный телефон. например. Захват HTTP-трафика для iOS. PCAPdroid для Android.

Установите необходимый сертификат согласно инструкции приложения для захвата пакетов.
Сканируйте приложение Ottai Share.

В заголовке запроса найдите authorization:«...» — это ваш OTTAI_TOKEN.

Если приложение Ottai переустанавливается или выполняется повторная процедура входа/выхода на том же устройстве - вам придется повторить описанный выше шаг.

Токен выдается на полгода, в течении этого времени он не должен меняться


### Запуск с помощью docker

Установите docker для выбранного дистрибутива.
Запустите сборку контейнера с приложением в директории с репозиторием

```
docker build -t ottai-nightscout-uploader .
```


#### Запуск через docker compose 
Можно запустить через docker compose
Вносите значения переменных в файл docker-compose.yml в разделе environment
Далее выполняете запуск из корня репозитория
```
docker compose up -d
```

### Запуск на телефоне через termux

Скачиваете [termux](https://play.google.com/store/apps/details?id=com.termux) на android смартфон

Запускаете и выполняете установку пакетов:
```
pkg up -y && pkg install openssl python3 git openssl-static openssl-tool
```

клонируете репозиторий:
```
git clone https://github.com/pmakhotkin/ottai-nightscout-uploader.git
```

выполняете переход в папку репозитория и установку зависиомстей:
```
cd ottai-nightscout-uploader/
pip install -r requirements.txt
```
редактируем файл .env. Вносим в него свои данные (токен пользователя, адрес nightscout и api secret и время перезапроса данных)

```
nano .env
```
Сохраняем файл нажатием ctrl+O

выполняем загрузку переменных окружения

```
source .env
```

Запускаем скрипт

```
python -u main.py
```
Если все ок, то видим как обмен данными пошел
В вводе будет что-то типа:
```
Nightscout POST request 200 OK                          
2024-10-17 11:04:19.483938
entries uploaded.
```

Если вывод будет отличаться, то необходимо еще раз проверить свои данные